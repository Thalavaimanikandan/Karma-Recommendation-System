import requests

class CategoryRecommender:
    def __init__(self, llama_url):
        self.llama_url = llama_url

    def extract_tags(self, text):
        payload = {"text": text}
        try:
            resp = requests.post(f"{self.llama_url}/extract-tags", json=payload, timeout=10)
            return resp.json().get("tags", [])
        except Exception as e:
            return {"error": str(e)}

class GorseRecommender:
    def __init__(self, gorse_url):
        self.gorse_url = gorse_url

    def get_recommendations(self, user_id, n=10, categories=None):
        params = f"?n={n}"
        if categories:
            params += "&categories=" + ",".join(categories)
        return requests.get(f"{self.gorse_url}/api/recommend/{user_id}{params}").json()

    def add_user(self, user_id, labels=[], comment=""):
        payload = {"UserId": user_id, "Labels": labels, "Comment": comment}
        return requests.post(f"{self.gorse_url}/api/user", json=payload).json()

    def add_item(self, item_id, labels, categories, comment, is_hidden=False):
        payload = {
            "ItemId": item_id,
            "Labels": labels,
            "Categories": categories,
            "Comment": comment,
            "IsHidden": is_hidden
        }
        return requests.post(f"{self.gorse_url}/api/item", json=payload).json()

    def add_feedback(self, user_id, item_id, feedback_type="read", timestamp=None):
        payload = [{
            "UserId": user_id,
            "ItemId": item_id,
            "FeedbackType": feedback_type,
            "Timestamp": timestamp
        }]
        return requests.post(f"{self.gorse_url}/api/feedback", json=payload).json()

    def get_popular_items(self, n=10, offset=0):
        return requests.get(f"{self.gorse_url}/api/popular?n={n}&offset={offset}").json()

    def get_latest_items(self, n=10, offset=0):
        return requests.get(f"{self.gorse_url}/api/latest?n={n}&offset={offset}").json()

    def get_similar_items(self, item_id, n=10, offset=0):
        return requests.get(f"{self.gorse_url}/api/item/{item_id}/similar?n={n}&offset={offset}").json()

class NSFWRecommender:
    def __init__(self, nsfw_url):
        self.nsfw_url = nsfw_url

    def moderate(self, text=None, image=None):
        payload = {"text": text, "image": image}
        return requests.post(f"{self.nsfw_url}/moderate", json=payload).json()

class Recommendation_System:
    def __init__(self, llama_url, gorse_url, nsfw_url):
        self.category_recommender = CategoryRecommender(llama_url)
        self.gorse_recommender = GorseRecommender(gorse_url)
        self.nsfw_recommender = NSFWRecommender(nsfw_url)

    def get_category_recommendations(self, text, top_k=10):
        return self.category_recommender.extract_tags(text)[:top_k]

    def get_gorse_recommendations(self, user_id, n=10, categories=None):
        return self.gorse_recommender.get_recommendations(user_id, n, categories)

    def moderate_content(self, text=None, image=None):
        return self.nsfw_recommender.moderate(text, image)
