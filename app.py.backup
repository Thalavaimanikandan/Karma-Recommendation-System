import os
import logging
from flask import Flask, request, jsonify
from flask_cors import CORS
from datetime import datetime

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Import your recommendation system
try:
    from recommendation import Recommendation_System
    logger.info("‚úÖ Recommendation module imported successfully")
except ImportError as e:
    logger.error(f"‚ùå Failed to import recommendation module: {e}")
    Recommendation_System = None

# Initialize Flask app
app = Flask(__name__)
CORS(app)

# Configuration
app.config['JSON_SORT_KEYS'] = False
app.config['JSONIFY_PRETTYPRINT_REGULAR'] = True

# Initialize recommendation system
recommender = None
if Recommendation_System:
    try:
        # Initialize with your data file path
        data_file = os.path.join('data', 'your_data.csv')  # Update this path
        recommender = Recommendation_System(data_file)
        logger.info("‚úÖ Recommendation system initialized")
    except Exception as e:
        logger.error(f"‚ùå Failed to initialize recommendation system: {e}")

# ================================
# API Endpoints
# ================================

@app.route('/')
def index():
    """Root endpoint"""
    return jsonify({
        'message': 'Recommendation System API',
        'version': '1.0.0',
        'status': 'running',
        'endpoints': {
            'health': '/api/health',
            'recommend': '/api/category/recommend',
            'stats': '/api/stats'
        }
    })

@app.route('/api/health', methods=['GET'])
def health_check():
    """Health check endpoint"""
    health_status = {
        'status': 'healthy',
        'timestamp': datetime.now().isoformat(),
        'services': {
            'api': 'running',
            'recommender': 'ready' if recommender else 'not initialized'
        }
    }
    
    # Check Ollama server
    try:
        import requests
        response = requests.get('http://localhost:11434/api/tags', timeout=2)
        health_status['services']['ollama'] = 'running' if response.status_code == 200 else 'error'
    except:
        health_status['services']['ollama'] = 'offline'
    
    return jsonify(health_status)

@app.route('/api/stats', methods=['GET'])
def get_stats():
    """Get system statistics"""
    if not recommender:
        return jsonify({'error': 'Recommendation system not initialized'}), 503
    
    try:
        stats = {
            'total_items': len(recommender.df) if hasattr(recommender, 'df') else 0,
            'model': recommender.model_name if hasattr(recommender, 'model_name') else 'unknown',
            'embedding_dim': recommender.embeddings.shape[1] if hasattr(recommender, 'embeddings') else 0,
            'status': 'ready'
        }
        return jsonify(stats)
    except Exception as e:
        logger.error(f"Error getting stats: {e}")
        return jsonify({'error': str(e)}), 500

@app.route('/api/category/recommend', methods=['POST'])
def recommend_category():
    """Get recommendations based on text query"""
    try:
        # Check if recommender is initialized
        if not recommender:
            return jsonify({
                'error': 'Recommendation system not initialized',
                'message': 'Please check if data file exists and system is properly configured'
            }), 503
        
        # Get request data
        data = request.json
        if not data:
            return jsonify({'error': 'No data provided'}), 400
        
        text = data.get('text', '').strip()
        top_k = data.get('top_k', 5)
        
        # Validate input
        if not text:
            return jsonify({'error': 'Text parameter is required'}), 400
        
        if not isinstance(top_k, int) or top_k < 1:
            return jsonify({'error': 'top_k must be a positive integer'}), 400
        
        logger.info(f"üîç Search query: '{text}', top_k: {top_k}")
        
        # Get recommendations
        recommendations = recommender.get_recommendations(text, top_k=top_k)
        
        # Convert DataFrame to list of dicts
        if recommendations is not None and len(recommendations) > 0:
            result = recommendations.to_dict('records')
            
            # Format similarity scores
            for item in result:
                if 'similarity_score' in item:
                    item['similarity_score'] = float(item['similarity_score'])
            
            logger.info(f"‚úÖ Found {len(result)} recommendations")
            
            return jsonify({
                'success': True,
                'query': text,
                'count': len(result),
                'recommendations': result
            })
        else:
            logger.warning(f"‚ö†Ô∏è No recommendations found for: '{text}'")
            return jsonify({
                'success': True,
                'query': text,
                'count': 0,
                'recommendations': [],
                'message': 'No recommendations found'
            })
            
    except AttributeError as e:
        logger.error(f"AttributeError: {e}")
        return jsonify({
            'error': 'Method not found',
            'message': 'Recommendation method not available. Check recommendation.py'
        }), 500
    except Exception as e:
        logger.error(f"Error in recommendation: {e}", exc_info=True)
        return jsonify({
            'error': 'Internal server error',
            'message': str(e)
        }), 500

@app.route('/api/test', methods=['GET'])
def test():
    """Test endpoint"""
    return jsonify({
        'message': 'API is working!',
        'timestamp': datetime.now().isoformat(),
        'recommender_status': 'initialized' if recommender else 'not initialized'
    })

# ================================
# Error Handlers
# ================================

@app.errorhandler(404)
def not_found(e):
    return jsonify({
        'error': 'Not Found',
        'message': 'The requested endpoint does not exist',
        'available_endpoints': [
            '/api/health',
            '/api/category/recommend',
            '/api/stats',
            '/api/test'
        ]
    }), 404

@app.errorhandler(500)
def internal_error(e):
    logger.error(f"Internal server error: {e}")
    return jsonify({
        'error': 'Internal Server Error',
        'message': 'An unexpected error occurred'
    }), 500

# ================================
# Main
# ================================

if __name__ == '__main__':
    print("=" * 60)
    print("üöÄ Starting Recommendation System API")
    print("=" * 60)
    print(f"üìç Server: http://0.0.0.0:5000")
    print(f"üìç Local: http://127.0.0.1:5000")
    print(f"üìä Health: http://127.0.0.1:5000/api/health")
    print(f"üîç Recommend: POST http://127.0.0.1:5000/api/category/recommend")
    print("=" * 60)
    
    # Run the Flask app
    app.run(
        host='0.0.0.0',
        port=5000,
        debug=False,
        threaded=True
    )